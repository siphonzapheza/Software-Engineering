{% extends 'tenders/base.html' %}

{% block title %}Dashboard - Tender Insight Hub{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>Dashboard</h1>
        <p class="lead">Welcome back, {{ user.username }}! Here's an overview of your tender activities.</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Workspace Items</h5>
                <h2 class="display-4">{{ workspace_count }}</h2>
                <p class="card-text">Tenders in your workspace</p>
                <a href="{% url 'tenders:workspace' %}" class="btn btn-primary">View Workspace</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Pending Tasks</h5>
                <h2 class="display-4">{{ pending_tasks_count }}</h2>
                <p class="card-text">Tasks awaiting completion</p>
                <a href="{% url 'tenders:workspace' %}" class="btn btn-primary">View Tasks</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Upcoming Deadlines</h5>
                <h2 class="display-4">{{ upcoming_deadlines_count }}</h2>
                <p class="card-text">Tenders closing in 7 days</p>
                <a href="{% url 'tenders:search' %}" class="btn btn-primary">View Tenders</a>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body">
                {% if recent_activity %}
                <div class="list-group">
                    {% for activity in recent_activity %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ activity.title }}</h5>
                            <small>{{ activity.timestamp|date:"M d, Y" }}</small>
                        </div>
                        <p class="mb-1">{{ activity.description }}</p>
                        <small>{{ activity.user }}</small>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No recent activity to display.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Tender Matches by Score</h5>
            </div>
            <div class="card-body">
                <canvas id="scoreChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Workspace Items by Status</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Score distribution chart
        const scoreCtx = document.getElementById('scoreChart').getContext('2d');
        const scoreChart = new Chart(scoreCtx, {
            type: 'pie',
            data: {
                labels: {{ readiness_score_labels|default:'["High (80-100)", "Medium (50-79)", "Low (0-49)"]'|safe }},
                datasets: [{
                    data: {{ readiness_score_data|default:'[0, 0, 0]'|safe }},
                    backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Status distribution chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: {{ workspace_status_labels|safe }},
                datasets: [{
                    data: {{ workspace_status_data|safe }},
                    backgroundColor: ['#6c757d', '#17a2b8', '#dc3545', '#28a745', '#6f42c1', '#fd7e14'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Readiness score chart
        const readinessCtx = document.getElementById('readinessChart').getContext('2d');
        const readinessChart = new Chart(readinessCtx, {
            type: 'bar',
            data: {
                labels: {{ readiness_score_labels|safe }},
                datasets: [{
                    label: 'Number of Tenders',
                    data: {{ readiness_score_data|safe }},
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderColor: ['#1e7e34', '#e0a800', '#c82333'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} tenders`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}